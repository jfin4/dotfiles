#!/bin/sh

# Check if arguments are provided
if [ "$#" -ne 3 ]; then
    echo "Usage: $0 <label> <path_to_kernel> <path_to_initrd>"
    echo "Example: $0 "Arch Linux" /boot/vmlinuz-linux /boot/initramfs-linux.img"
    exit 1
fi

# 1. Process Arguments: Strip paths to get basenames
BOOT_LABEL="$1"
KERNEL_BASENAME=$(basename "$2")
INITRD_BASENAME=$(basename "$3")

# 2. Format for efibootmgr
# Loader needs a forward slash: /vmlinuz-linux
LOADER_PATH="/${KERNEL_BASENAME}"
# Initrd needs a backslash (escaped): \initramfs-linux.img
INITRD_PATH="\\${INITRD_BASENAME}"

# 3. Find the EFI partition device by label "efi"
EFI_DEV=$(findfs LABEL="efi" 2>/dev/null || findfs PARTLABEL="efi" 2>/dev/null)

if [ -z "$EFI_DEV" ]; then
    echo "Error: Could not find partition with label 'efi'"
    exit 1
fi

# 4. Get the parent Disk and Partition Number
EFI_DISK="/dev/$(lsblk -no PKNAME "$EFI_DEV")"
EFI_PART="$(lsblk -no PARTN "$EFI_DEV")"

# 5. Find the Root partition PARTUUID by label "root"
ROOT_DEV=$(findfs LABEL="root" 2>/dev/null || findfs PARTLABEL="root" 2>/dev/null)

if [ -z "$ROOT_DEV" ]; then
    echo "Error: Could not find partition with label 'root'"
    exit 1
fi

ROOT_PARTUUID=$(lsblk -no PARTUUID "$ROOT_DEV")

# Display Configuration
echo "--------------------------------------------------"
echo "Configuration detected:"
echo "  Boot Label:    $BOOT_LABEL"
echo "  Target Disk:   $EFI_DISK"
echo "  Target Part:   $EFI_PART"
echo "  Root UUID:     $ROOT_PARTUUID"
echo "  Loader:        $LOADER_PATH"
echo "  Initrd:        $INITRD_PATH"
echo "--------------------------------------------------"

# 6. Ask for confirmation
read -p "Create boot entry with these settings? [y/N] " response

# Check if response starts with y or Y
if [[ ! "$response" =~ ^[yY] ]]; then
    echo "Operation aborted by user."
    exit 0
fi

# 7. Run efibootmgr
echo "Executing efibootmgr..."
sudo efibootmgr \
  --create \
  --disk "$EFI_DISK" \
  --part "$EFI_PART" \
  --label "$BOOT_LABEL" \
  --loader "$LOADER_PATH" \
  --unicode "root=PARTUUID=${ROOT_PARTUUID} rw initrd=${INITRD_PATH}" \
  --verbose

# for hibernation 
#
#     1. add boot options
#
#     --unicode 'resume=UUID=<uuid> resume_offset=<offset>' \
#     resume must be uuid if swap is swapfile because it is not a partition
#     get resume_offset:
#         filefrag -v /swapfile | awk '{if($1=="0:"){print $4}}' | sed 's/\.\.//'
#
#     2. add resume hook
#
#     add 'resume' to HOOKS(...) in /etc/mkinitcpio.conf
#     rebuild initrd with `mkinitcpio -P`

